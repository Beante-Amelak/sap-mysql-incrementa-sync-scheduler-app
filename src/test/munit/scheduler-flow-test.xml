<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
	xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
		http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

	<munit:config name="scheduler-flow-test-suite" doc:name="MUnit Configuration"/>

	<!-- Test: Scheduler Flow with Records to Process -->
	<munit:test name="scheduler-flow-with-records-test" 
		doc:name="Test Scheduler Flow With Records" 
		description="Verifies scheduler flow processes records correctly">
		
		<munit:behavior>
			<!-- Mock Object Store Retrieve for Watermark -->
			<munit-tools:mock-when processor="os:retrieve">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="Retrieve Watermark" attributeName="doc:name"/>
				</munit-tools:with-attributes>
				<munit-tools:then-return>
					<munit-tools:variables>
						<munit-tools:variable key="currentWatermark" value="#['2024-01-01T00:00:00Z']"/>
					</munit-tools:variables>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Object Store Contains for Lock Check -->
			<munit-tools:mock-when processor="os:contains">
				<munit-tools:then-return>
					<munit-tools:variables>
						<munit-tools:variable key="lockExists" value="#[false]"/>
					</munit-tools:variables>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Object Store Store for Lock Acquire -->
			<munit-tools:mock-when processor="os:store">
				<munit-tools:then-return/>
			</munit-tools:mock-when>

			<!-- Mock Object Store Remove for Lock Release -->
			<munit-tools:mock-when processor="os:remove">
				<munit-tools:then-return/>
			</munit-tools:mock-when>

			<!-- Mock Database Select -->
			<munit-tools:mock-when processor="db:select">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[
						{
							'id': 1,
							'order_number': 'ORD-001',
							'customer_id': 'CUST001',
							'customer_name': 'Test Customer',
							'material_number': 'MAT001',
							'material_description': 'Test Material',
							'quantity': 10,
							'unit_of_measure': 'EA',
							'unit_price': 100.00,
							'total_amount': 1000.00,
							'currency': 'USD',
							'order_date': now() as Date,
							'delivery_date': (now() + |P7D|) as Date,
							'plant_code': '1000',
							'storage_location': '0001',
							'sales_organization': '1000',
							'distribution_channel': '10',
							'division': '00',
							'status': 'NEW',
							'created_at': now(),
							'updated_at': now()
						}
					]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock SAP RFC Call -->
			<munit-tools:mock-when processor="sap:synchronous-remote-function-call">
				<munit-tools:then-return>
					<munit-tools:payload value="#[{
						'BAPI_SALESORDER_CREATEFROMDAT2': {
							'export': {
								'SALESDOCUMENT': '0000012345'
							},
							'tables': {
								'RETURN': {
									'row': [{
										'TYPE': 'S',
										'NUMBER': '000',
										'MESSAGE': 'Sales order created successfully'
									}]
								}
							}
						}
					}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Set initial event -->
			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute Scheduler Flow" name="mysql-sap-sync-scheduler-flow"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:assert-that 
				expression="#[vars.syncMetrics.recordsRead]" 
				is="#[MunitTools::greaterThanOrEqualTo(0)]"
				message="Records read should be tracked"/>
		</munit:validation>
	</munit:test>

	<!-- Test: Scheduler Flow with No Records -->
	<munit:test name="scheduler-flow-no-records-test" 
		doc:name="Test Scheduler Flow No Records" 
		description="Verifies scheduler flow handles empty result set">
		
		<munit:behavior>
			<!-- Mock Object Store Retrieve for Watermark -->
			<munit-tools:mock-when processor="os:retrieve">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="Retrieve Watermark" attributeName="doc:name"/>
				</munit-tools:with-attributes>
				<munit-tools:then-return>
					<munit-tools:variables>
						<munit-tools:variable key="currentWatermark" value="#['2024-01-01T00:00:00Z']"/>
					</munit-tools:variables>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Object Store Contains for Lock Check -->
			<munit-tools:mock-when processor="os:contains">
				<munit-tools:then-return>
					<munit-tools:variables>
						<munit-tools:variable key="lockExists" value="#[false]"/>
					</munit-tools:variables>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Object Store Store for Lock Acquire -->
			<munit-tools:mock-when processor="os:store">
				<munit-tools:then-return/>
			</munit-tools:mock-when>

			<!-- Mock Object Store Remove for Lock Release -->
			<munit-tools:mock-when processor="os:remove">
				<munit-tools:then-return/>
			</munit-tools:mock-when>

			<!-- Mock Database Select - Empty Result -->
			<munit-tools:mock-when processor="db:select">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute Scheduler Flow" name="mysql-sap-sync-scheduler-flow"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:assert-that 
				expression="#[vars.syncMetrics.recordsRead]" 
				is="#[MunitTools::equalTo(0)]"
				message="Records read should be 0 for empty result"/>
		</munit:validation>
	</munit:test>

	<!-- Test: Scheduler Flow with Lock Already Held -->
	<munit:test name="scheduler-flow-lock-held-test" 
		doc:name="Test Scheduler Flow Lock Held" 
		description="Verifies scheduler flow handles lock contention"
		expectedErrorType="APP:LOCK_HELD">
		
		<munit:behavior>
			<!-- Mock Object Store Contains - Lock Exists -->
			<munit-tools:mock-when processor="os:contains">
				<munit-tools:then-return>
					<munit-tools:variables>
						<munit-tools:variable key="lockExists" value="#[true]"/>
					</munit-tools:variables>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute Scheduler Flow" name="mysql-sap-sync-scheduler-flow"/>
		</munit:execution>
	</munit:test>

</mule>
