<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
	xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
		http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

	<munit:config name="mysql-fetch-subflow-test-suite" doc:name="MUnit Configuration"/>

	<!-- Test: MySQL Fetch with Multiple Records -->
	<munit:test name="mysql-fetch-multiple-records-test" 
		doc:name="Test MySQL Fetch Multiple Records" 
		description="Verifies MySQL fetch returns and transforms multiple records correctly">
		
		<munit:behavior>
			<!-- Mock Database Select with Multiple Records -->
			<munit-tools:mock-when processor="db:select">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[
						{
							'id': 1,
							'order_number': 'ORD-001',
							'customer_id': 'CUST001',
							'customer_name': 'Customer One',
							'material_number': 'MAT001',
							'material_description': 'Material One',
							'quantity': 10,
							'unit_of_measure': 'EA',
							'unit_price': 100.00,
							'total_amount': 1000.00,
							'currency': 'USD',
							'order_date': '2024-01-15' as Date,
							'delivery_date': '2024-01-22' as Date,
							'plant_code': '1000',
							'storage_location': '0001',
							'sales_organization': '1000',
							'distribution_channel': '10',
							'division': '00',
							'status': 'NEW',
							'created_at': '2024-01-15T10:00:00Z' as DateTime,
							'updated_at': '2024-01-15T10:00:00Z' as DateTime
						},
						{
							'id': 2,
							'order_number': 'ORD-002',
							'customer_id': 'CUST002',
							'customer_name': 'Customer Two',
							'material_number': 'MAT002',
							'material_description': 'Material Two',
							'quantity': 20,
							'unit_of_measure': 'KG',
							'unit_price': 50.00,
							'total_amount': 1000.00,
							'currency': 'EUR',
							'order_date': '2024-01-16' as Date,
							'delivery_date': '2024-01-23' as Date,
							'plant_code': '2000',
							'storage_location': '0002',
							'sales_organization': '2000',
							'distribution_channel': '20',
							'division': '10',
							'status': 'PENDING',
							'created_at': '2024-01-16T11:00:00Z' as DateTime,
							'updated_at': '2024-01-16T11:00:00Z' as DateTime
						}
					]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
				<munit:variables>
					<munit:variable key="currentWatermark" value="#['2024-01-01T00:00:00Z']"/>
				</munit:variables>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute MySQL Fetch" name="mysql-fetch-incremental-subflow"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:assert-that 
				expression="#[sizeOf(payload)]" 
				is="#[MunitTools::equalTo(2)]"
				message="Should return 2 records"/>
			<munit-tools:assert-that 
				expression="#[payload[0].orderNumber]" 
				is="#[MunitTools::equalTo('ORD-001')]"
				message="First record order number should be ORD-001"/>
			<munit-tools:assert-that 
				expression="#[payload[1].customerId]" 
				is="#[MunitTools::equalTo('CUST002')]"
				message="Second record customer ID should be CUST002"/>
		</munit:validation>
	</munit:test>

	<!-- Test: MySQL Fetch with Empty Result -->
	<munit:test name="mysql-fetch-empty-result-test" 
		doc:name="Test MySQL Fetch Empty Result" 
		description="Verifies MySQL fetch handles empty result set">
		
		<munit:behavior>
			<!-- Mock Database Select with Empty Result -->
			<munit-tools:mock-when processor="db:select">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
				<munit:variables>
					<munit:variable key="currentWatermark" value="#['2024-12-31T23:59:59Z']"/>
				</munit:variables>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute MySQL Fetch" name="mysql-fetch-incremental-subflow"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:assert-that 
				expression="#[sizeOf(payload)]" 
				is="#[MunitTools::equalTo(0)]"
				message="Should return empty array"/>
		</munit:validation>
	</munit:test>

	<!-- Test: MySQL Fetch Field Mapping -->
	<munit:test name="mysql-fetch-field-mapping-test" 
		doc:name="Test MySQL Fetch Field Mapping" 
		description="Verifies field mapping from snake_case to camelCase">
		
		<munit:behavior>
			<!-- Mock Database Select -->
			<munit-tools:mock-when processor="db:select">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[
						{
							'id': 100,
							'order_number': 'TEST-ORD',
							'customer_id': 'TEST-CUST',
							'customer_name': 'Test Customer Name',
							'material_number': 'TEST-MAT',
							'material_description': 'Test Material Description',
							'quantity': 5,
							'unit_of_measure': 'PC',
							'unit_price': 25.50,
							'total_amount': 127.50,
							'currency': 'GBP',
							'order_date': '2024-02-01' as Date,
							'delivery_date': '2024-02-08' as Date,
							'plant_code': '3000',
							'storage_location': '0003',
							'sales_organization': '3000',
							'distribution_channel': '30',
							'division': '20',
							'status': 'CONFIRMED',
							'created_at': '2024-02-01T09:00:00Z' as DateTime,
							'updated_at': '2024-02-01T09:30:00Z' as DateTime
						}
					]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
				<munit:variables>
					<munit:variable key="currentWatermark" value="#['2024-01-01T00:00:00Z']"/>
				</munit:variables>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute MySQL Fetch" name="mysql-fetch-incremental-subflow"/>
		</munit:execution>

		<munit:validation>
			<!-- Verify camelCase field mapping -->
			<munit-tools:assert-that 
				expression="#[payload[0].id]" 
				is="#[MunitTools::equalTo(100)]"
				message="ID should be mapped correctly"/>
			<munit-tools:assert-that 
				expression="#[payload[0].orderNumber]" 
				is="#[MunitTools::equalTo('TEST-ORD')]"
				message="orderNumber should be mapped from order_number"/>
			<munit-tools:assert-that 
				expression="#[payload[0].customerId]" 
				is="#[MunitTools::equalTo('TEST-CUST')]"
				message="customerId should be mapped from customer_id"/>
			<munit-tools:assert-that 
				expression="#[payload[0].materialDescription]" 
				is="#[MunitTools::equalTo('Test Material Description')]"
				message="materialDescription should be mapped from material_description"/>
			<munit-tools:assert-that 
				expression="#[payload[0].unitOfMeasure]" 
				is="#[MunitTools::equalTo('PC')]"
				message="unitOfMeasure should be mapped from unit_of_measure"/>
			<munit-tools:assert-that 
				expression="#[payload[0].salesOrganization]" 
				is="#[MunitTools::equalTo('3000')]"
				message="salesOrganization should be mapped from sales_organization"/>
		</munit:validation>
	</munit:test>

	<!-- Test: MySQL Health Check -->
	<munit:test name="mysql-health-check-test" 
		doc:name="Test MySQL Health Check" 
		description="Verifies MySQL health check subflow">
		
		<munit:behavior>
			<!-- Mock Database Select for Health Check -->
			<munit-tools:mock-when processor="db:select">
				<munit-tools:then-return>
					<munit-tools:payload value="#[[{'health_check': 1}]]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute Health Check" name="mysql-health-check-subflow"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:assert-that 
				expression="#[payload[0].health_check]" 
				is="#[MunitTools::equalTo(1)]"
				message="Health check should return 1"/>
		</munit:validation>
	</munit:test>

</mule>
