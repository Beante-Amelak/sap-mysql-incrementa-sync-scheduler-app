<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
	xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
		http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

	<munit:config name="watermark-management-test-suite" doc:name="MUnit Configuration"/>

	<!-- Test: Retrieve Watermark - Existing Value -->
	<munit:test name="retrieve-watermark-existing-test" 
		doc:name="Test Retrieve Existing Watermark" 
		description="Verifies watermark retrieval when value exists">
		
		<munit:behavior>
			<!-- Mock Object Store Retrieve -->
			<munit-tools:mock-when processor="os:retrieve">
				<munit-tools:then-return>
					<munit-tools:variables>
						<munit-tools:variable key="currentWatermark" value="#['2024-06-15T14:30:00Z']"/>
					</munit-tools:variables>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute Retrieve Watermark" name="retrieve-watermark-subflow"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:assert-that 
				expression="#[vars.currentWatermark]" 
				is="#[MunitTools::equalTo('2024-06-15T14:30:00Z')]"
				message="Watermark should be retrieved correctly"/>
		</munit:validation>
	</munit:test>

	<!-- Test: Retrieve Watermark - Default Value -->
	<munit:test name="retrieve-watermark-default-test" 
		doc:name="Test Retrieve Default Watermark" 
		description="Verifies watermark retrieval uses default when key not found">
		
		<munit:behavior>
			<!-- Mock Object Store Retrieve with Default -->
			<munit-tools:mock-when processor="os:retrieve">
				<munit-tools:then-return>
					<munit-tools:variables>
						<munit-tools:variable key="currentWatermark" value="#['1970-01-01T00:00:00Z']"/>
					</munit-tools:variables>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute Retrieve Watermark" name="retrieve-watermark-subflow"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:assert-that 
				expression="#[vars.currentWatermark]" 
				is="#[MunitTools::equalTo('1970-01-01T00:00:00Z')]"
				message="Default watermark should be used"/>
		</munit:validation>
	</munit:test>

	<!-- Test: Persist Watermark -->
	<munit:test name="persist-watermark-test" 
		doc:name="Test Persist Watermark" 
		description="Verifies watermark persistence">
		
		<munit:behavior>
			<!-- Mock Object Store Store -->
			<munit-tools:mock-when processor="os:store">
				<munit-tools:then-return/>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Watermark to Persist">
				<munit:payload value="#[null]"/>
				<munit:variables>
					<munit:variable key="currentWatermark" value="#['2024-07-01T10:00:00Z']"/>
				</munit:variables>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute Persist Watermark" name="persist-watermark-subflow"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:verify-call processor="os:store" times="1">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="Store Watermark" attributeName="doc:name"/>
				</munit-tools:with-attributes>
			</munit-tools:verify-call>
		</munit:validation>
	</munit:test>

	<!-- Test: Acquire Distributed Lock - Success -->
	<munit:test name="acquire-lock-success-test" 
		doc:name="Test Acquire Lock Success" 
		description="Verifies distributed lock acquisition when lock is available">
		
		<munit:behavior>
			<!-- Mock Object Store Contains - Lock Not Exists -->
			<munit-tools:mock-when processor="os:contains">
				<munit-tools:then-return>
					<munit-tools:variables>
						<munit-tools:variable key="lockExists" value="#[false]"/>
					</munit-tools:variables>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Object Store Store -->
			<munit-tools:mock-when processor="os:store">
				<munit-tools:then-return/>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute Acquire Lock" name="acquire-distributed-lock-subflow"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:verify-call processor="os:store" times="1">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="Acquire Lock" attributeName="doc:name"/>
				</munit-tools:with-attributes>
			</munit-tools:verify-call>
		</munit:validation>
	</munit:test>

	<!-- Test: Acquire Distributed Lock - Already Held -->
	<munit:test name="acquire-lock-already-held-test" 
		doc:name="Test Acquire Lock Already Held" 
		description="Verifies error when lock is already held"
		expectedErrorType="APP:LOCK_HELD">
		
		<munit:behavior>
			<!-- Mock Object Store Contains - Lock Exists -->
			<munit-tools:mock-when processor="os:contains">
				<munit-tools:then-return>
					<munit-tools:variables>
						<munit-tools:variable key="lockExists" value="#[true]"/>
					</munit-tools:variables>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute Acquire Lock" name="acquire-distributed-lock-subflow"/>
		</munit:execution>
	</munit:test>

	<!-- Test: Release Distributed Lock -->
	<munit:test name="release-lock-test" 
		doc:name="Test Release Lock" 
		description="Verifies distributed lock release">
		
		<munit:behavior>
			<!-- Mock Object Store Remove -->
			<munit-tools:mock-when processor="os:remove">
				<munit-tools:then-return/>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute Release Lock" name="release-distributed-lock-subflow"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:verify-call processor="os:remove" times="1">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="Remove Lock" attributeName="doc:name"/>
				</munit-tools:with-attributes>
			</munit-tools:verify-call>
		</munit:validation>
	</munit:test>

	<!-- Test: Reset Watermark -->
	<munit:test name="reset-watermark-test" 
		doc:name="Test Reset Watermark" 
		description="Verifies watermark reset to default value">
		
		<munit:behavior>
			<!-- Mock Object Store Remove -->
			<munit-tools:mock-when processor="os:remove">
				<munit-tools:then-return/>
			</munit-tools:mock-when>

			<!-- Mock Object Store Store -->
			<munit-tools:mock-when processor="os:store">
				<munit-tools:then-return/>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute Reset Watermark" name="reset-watermark-subflow"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:verify-call processor="os:store" times="1">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="Store Default Watermark" attributeName="doc:name"/>
				</munit-tools:with-attributes>
			</munit-tools:verify-call>
		</munit:validation>
	</munit:test>

	<!-- Test: Watermark Integrity on Failure -->
	<munit:test name="watermark-integrity-on-failure-test" 
		doc:name="Test Watermark Integrity on Failure" 
		description="Verifies watermark is not updated when processing fails">
		
		<munit:behavior>
			<!-- Mock Object Store Retrieve -->
			<munit-tools:mock-when processor="os:retrieve">
				<munit-tools:then-return>
					<munit-tools:variables>
						<munit-tools:variable key="currentWatermark" value="#['2024-01-01T00:00:00Z']"/>
					</munit-tools:variables>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<munit:set-event doc:name="Set Initial Event">
				<munit:payload value="#[null]"/>
			</munit:set-event>
		</munit:behavior>

		<munit:execution>
			<flow-ref doc:name="Execute Retrieve Watermark" name="retrieve-watermark-subflow"/>
		</munit:execution>

		<munit:validation>
			<!-- Verify watermark was retrieved but not stored (no persist call) -->
			<munit-tools:assert-that 
				expression="#[vars.currentWatermark]" 
				is="#[MunitTools::equalTo('2024-01-01T00:00:00Z')]"
				message="Original watermark should be preserved"/>
			<munit-tools:verify-call processor="os:store" times="0"/>
		</munit:validation>
	</munit:test>

</mule>
